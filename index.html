<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Flow Tracker - Google Sheets Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(180deg, #4739a6 0%, #d483f8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(180deg, #4739a6 0%, #d483f8 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .sync-indicator.disconnected {
            background: #f44336;
        }

        .sync-indicator.syncing {
            background: #FFC107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #7E5FCF;
            color: white;
        }

        .btn-primary:hover {
            background: #A265DA;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            border-color: #A265DA;
            color: #A265DA;
        }

        .btn-secondary.active {
            background: #7E5FCF;
            color: white;
            border-color: #7E5FCF;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .main-content {
            padding: 40px;
        }

        .sankey-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 500px;
        }

        #sankey {
            width: 100%;
            height: 500px;
        }

        .entries-section {
            margin-top: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .entries-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .entries-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        .entries-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .entries-table tr:hover {
            background: #f8f9fa;
        }

        .entry-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-edit {
            background: #4CAF50;
            color: white;
        }

        .btn-edit:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #da190b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .form-actions button {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .summary-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        .summary-card.income .summary-card-value {
            color: #4CAF50;
        }

        .summary-card.expense .summary-card-value {
            color: #f44336;
        }

        .summary-card.balance .summary-card-value {
            color: #A265DA;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-income {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-expense {
            background: #ffebee;
            color: #c62828;
        }

        .setup-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
        }

        .setup-step {
            margin-bottom: 30px;
        }

        .setup-step h3 {
            color: #7E5FCF;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .setup-step p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .setup-step code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .setup-step ol {
            margin-left: 20px;
            color: #666;
            line-height: 1.8;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .info-box p {
            color: #1976D2;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Orion Racing Finance Tracker</h1>
                <div class="subtitle">Synced with Google Sheets</div>
            </div>
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">Disconnected</span>
            </div>
        </header>

        <div class="controls">
            <button class="btn-primary" id="connectBtn" onclick="handleAuthClick()">Connect Google Sheets</button>
            <button class="btn-primary" id="addEntryBtn" onclick="openAddModal()" disabled>Add Entry</button>
            <button class="btn-secondary" onclick="toggleEntriesView()">View All Entries</button>
            
            <div class="filter-group">
                <button class="btn-secondary active" onclick="setFilter('month')">This Month</button>
                <button class="btn-secondary" onclick="setFilter('3months')">Last 3 Months</button>
                <button class="btn-secondary" onclick="setFilter('6months')">Last 6 Months</button>
                <button class="btn-secondary" onclick="setFilter('year')">Year to Date</button>
            </div>
        </div>

        <div class="main-content">
            <div class="summary-cards">
                <div class="summary-card income">
                    <div class="summary-card-title">Total Income</div>
                    <div class="summary-card-value" id="totalIncome">$0</div>
                </div>
                <div class="summary-card expense">
                    <div class="summary-card-title">Total Expenses</div>
                    <div class="summary-card-value" id="totalExpense">$0</div>
                </div>
                <div class="summary-card balance">
                    <div class="summary-card-title">Net Balance</div>
                    <div class="summary-card-value" id="netBalance">$0</div>
                </div>
            </div>

            <div class="sankey-container">
                <div id="sankey"></div>
            </div>

            <div class="entries-section" id="entriesSection" style="display: none;">
                <h2 class="section-title">All Entries</h2>
                <div id="entriesTableContainer"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="entryModal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">Add Entry</h2>
            <form id="entryForm" onsubmit="saveEntry(event)">
                <input type="hidden" id="entryId">
                
                <div class="form-group">
                    <label>Type *</label>
                    <select id="entryType" required>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Category *</label>
                    <input type="text" id="entryCategory" required placeholder="e.g., Salary, Rent, Food">
                </div>

                <div class="form-group">
                    <label>Subcategory</label>
                    <input type="text" id="entrySubcategory" placeholder="Optional">
                </div>

                <div class="form-group">
                    <label>Amount ($) *</label>
                    <input type="number" id="entryAmount" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="entryDate" required>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="entryNotes" placeholder="Optional notes"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal active" id="setupModal">
        <div class="setup-modal">
            <h2 class="modal-title">Setup Google Sheets Integration</h2>
            
            <div class="setup-step">
                <h3>Step 1: Create Google Cloud Project</h3>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                    <li>Create a new project or select an existing one</li>
                    <li>Enable the <strong>Google Sheets API</strong></li>
                </ol>
            </div>

            <div class="setup-step">
                <h3>Step 2: Create OAuth Credentials</h3>
                <ol>
                    <li>Go to "APIs & Services" ‚Üí "Credentials"</li>
                    <li>Click "Create Credentials" ‚Üí "OAuth client ID"</li>
                    <li>Select "Web application"</li>
                    <li>Add authorized JavaScript origins (your website URL)</li>
                    <li>Copy your <strong>Client ID</strong></li>
                </ol>
            </div>

            <div class="setup-step">
                <h3>Step 3: Configure This App</h3>
                <p>Paste your Client ID below:</p>
                <input type="text" id="clientIdInput" placeholder="YOUR_CLIENT_ID.apps.googleusercontent.com" style="margin-bottom: 15px;">
                
                <p>Enter your Google Sheet ID (from the URL):</p>
                <input type="text" id="sheetIdInput" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                
                <div class="info-box">
                    <p><strong>Note:</strong> The Sheet ID is the long string in your Google Sheets URL between /d/ and /edit</p>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn-primary" onclick="saveSetup()">Save & Connect</button>
            </div>
        </div>
    </div>

    <script>
        let entries = [];
        let currentFilter = 'month';
        let editingId = null;
        let tokenClient;
        let accessToken = null;
        let CLIENT_ID = '';
        let SHEET_ID = '';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        function saveSetup() {
            CLIENT_ID = document.getElementById('clientIdInput').value.trim();
            SHEET_ID = document.getElementById('sheetIdInput').value.trim();
            
            if (!CLIENT_ID || !SHEET_ID) {
                alert('Please enter both Client ID and Sheet ID');
                return;
            }
            
            localStorage.setItem('googleClientId', CLIENT_ID);
            localStorage.setItem('googleSheetId', SHEET_ID);
            
            document.getElementById('setupModal').classList.remove('active');
            initializeGoogleAuth();
        }

        function initializeGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        throw (response);
                    }
                    accessToken = response.access_token;
                    updateSyncStatus('connected');
                    document.getElementById('addEntryBtn').disabled = false;
                    document.getElementById('connectBtn').textContent = 'Refresh Connection';
                    loadFromGoogleSheets();
                },
            });
        }

        function handleAuthClick() {
            if (!CLIENT_ID || !SHEET_ID) {
                document.getElementById('setupModal').classList.add('active');
                return;
            }
            
            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            indicator.className = 'sync-indicator';
            
            switch(status) {
                case 'connected':
                    indicator.classList.add('connected');
                    statusText.textContent = 'Connected';
                    break;
                case 'syncing':
                    indicator.classList.add('syncing');
                    statusText.textContent = 'Syncing...';
                    break;
                case 'disconnected':
                    indicator.classList.add('disconnected');
                    statusText.textContent = 'Disconnected';
                    break;
            }
        }

        async function loadFromGoogleSheets() {
            if (!accessToken) return;
            
            updateSyncStatus('syncing');
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:G`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    entries = data.values.slice(1).map(row => ({
                        id: row[0] || Date.now().toString(),
                        type: row[1] || 'expense',
                        category: row[2] || '',
                        subcategory: row[3] || '',
                        amount: parseFloat(row[4]) || 0,
                        date: row[5] || '',
                        notes: row[6] || ''
                    })).filter(e => e.id && e.amount);
                } else {
                    await initializeGoogleSheet();
                }
                
                updateSyncStatus('connected');
                updateDashboard();
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                updateSyncStatus('disconnected');
                alert('Error loading data from Google Sheets. Please check your Sheet ID and permissions.');
            }
        }

        async function initializeGoogleSheet() {
            const headers = [['ID', 'Type', 'Category', 'Subcategory', 'Amount', 'Date', 'Notes']];
            
            await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A1:G1?valueInputOption=RAW`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: headers
                    })
                }
            );
        }

        async function saveToGoogleSheets() {
            if (!accessToken) return;
            
            updateSyncStatus('syncing');
            
            try {
                const values = [
                    ['ID', 'Type', 'Category', 'Subcategory', 'Amount', 'Date', 'Notes'],
                    ...entries.map(e => [
                        e.id,
                        e.type,
                        e.category,
                        e.subcategory || '',
                        e.amount,
                        e.date,
                        e.notes || ''
                    ])
                ];
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:G?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: values
                        })
                    }
                );
                
                updateSyncStatus('connected');
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                updateSyncStatus('disconnected');
                alert('Error saving to Google Sheets. Please reconnect.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            CLIENT_ID = localStorage.getItem('googleClientId') || '';
            SHEET_ID = localStorage.getItem('googleSheetId') || '';
            
            if (CLIENT_ID && SHEET_ID) {
                document.getElementById('setupModal').classList.remove('active');
                document.getElementById('clientIdInput').value = CLIENT_ID;
                document.getElementById('sheetIdInput').value = SHEET_ID;
            }
            
            document.getElementById('entryDate').valueAsDate = new Date();
            updateDashboard();
        });

        function openAddModal() {
            if (!accessToken) {
                alert('Please connect to Google Sheets first');
                return;
            }
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add Entry';
            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            document.getElementById('entryModal').classList.add('active');
        }

        function openEditModal(id) {
            editingId = id;
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            document.getElementById('modalTitle').textContent = 'Edit Entry';
            document.getElementById('entryType').value = entry.type;
            document.getElementById('entryCategory').value = entry.category;
            document.getElementById('entrySubcategory').value = entry.subcategory || '';
            document.getElementById('entryAmount').value = entry.amount;
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('entryNotes').value = entry.notes || '';
            document.getElementById('entryModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('entryModal').classList.remove('active');
            document.getElementById('entryForm').reset();
            editingId = null;
        }

        async function saveEntry(event) {
            event.preventDefault();

            const entry = {
                id: editingId || Date.now().toString(),
                type: document.getElementById('entryType').value,
                category: document.getElementById('entryCategory').value,
                subcategory: document.getElementById('entrySubcategory').value,
                amount: parseFloat(document.getElementById('entryAmount').value),
                date: document.getElementById('entryDate').value,
                notes: document.getElementById('entryNotes').value
            };

            if (editingId) {
                const index = entries.findIndex(e => e.id === editingId);
                entries[index] = entry;
            } else {
                entries.push(entry);
            }

            await saveToGoogleSheets();
            closeModal();
            updateDashboard();
        }

        async function deleteEntry(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            entries = entries.filter(e => e.id !== id);
            await saveToGoogleSheets();
            updateDashboard();
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateDashboard();
        }

        function getFilteredEntries() {
            const today = new Date();
            const startDates = {
                'month': new Date(today.getFullYear(), today.getMonth(), 1),
                '3months': new Date(today.getFullYear(), today.getMonth() - 3, today.getDate()),
                '6months': new Date(today.getFullYear(), today.getMonth() - 6, today.getDate()),
                'year': new Date(today.getFullYear(), 0, 1)
            };

            const startDate = startDates[currentFilter];
            return entries.filter(e => new Date(e.date) >= startDate);
        }

        function updateDashboard() {
            const filtered = getFilteredEntries();
            updateSummary(filtered);
            updateSankey(filtered);
            if (document.getElementById('entriesSection').style.display !== 'none') {
                updateEntriesTable();
            }
        }

        function updateSummary(filtered) {
            const income = filtered.filter(e => e.type === 'income').reduce((sum, e) => sum + e.amount, 0);
            const expense = filtered.filter(e => e.type === 'expense').reduce((sum, e) => sum + e.amount, 0);
            const balance = income - expense;

            document.getElementById('totalIncome').textContent = '$' + income.toFixed(2);
            document.getElementById('totalExpense').textContent = '$' + expense.toFixed(2);
            document.getElementById('netBalance').textContent = '$' + balance.toFixed(2);
        }

        function updateSankey(filtered) {
            const container = document.getElementById('sankey');
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <h3>No data yet</h3>
                        <p>Add your first entry to see the money flow visualization</p>
                    </div>
                `;
                return;
            }

            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            function getNodeIndex(name) {
                if (!nodeMap.has(name)) {
                    nodeMap.set(name, nodes.length);
                    nodes.push({ name });
                }
                return nodeMap.get(name);
            }

            const incomeIdx = getNodeIndex('Income');
            const incomeByCategory = {};
            const incomeSubcategories = {};
            
            filtered.filter(e => e.type === 'income').forEach(e => {
                const category = (e.category && e.category.trim()) || 'Other Income';
                incomeByCategory[category] = (incomeByCategory[category] || 0) + e.amount;

                const subcategory = (e.subcategory || '').trim();
                if (subcategory) {
                    if (!incomeSubcategories[category]) {
                        incomeSubcategories[category] = {};
                    }
                    incomeSubcategories[category][subcategory] = (incomeSubcategories[category][subcategory] || 0) + e.amount;
                }
            });

            Object.entries(incomeByCategory).forEach(([category, amount]) => {
                const catIdx = getNodeIndex(category);
                links.push({ source: catIdx, target: incomeIdx, value: amount });
            });

            Object.entries(incomeSubcategories).forEach(([category, subcategories]) => {
                const catIdx = getNodeIndex(category);
                Object.entries(subcategories).forEach(([subcategory, amount]) => {
                    const subNodeName = `${subcategory}`;
                    const subIdx = getNodeIndex(subNodeName);
                    links.push({ source: subIdx, target: catIdx, value: amount });
                });
            });

            const expenseByCategory = {};
            const expenseSubcategories = {};
            
            filtered.filter(e => e.type === 'expense').forEach(e => {
                const sourceCategory = (e.category && e.category.trim()) || 'Other Expenses';
                expenseByCategory[sourceCategory] = (expenseByCategory[sourceCategory] || 0) + e.amount;

                const subcategory = (e.subcategory || '').trim();
                if (subcategory) {
                    if (!expenseSubcategories[sourceCategory]) {
                        expenseSubcategories[sourceCategory] = {};
                    }
                    expenseSubcategories[sourceCategory][subcategory] = (expenseSubcategories[sourceCategory][subcategory] || 0) + e.amount;
                }
            });

            Object.entries(expenseByCategory).forEach(([category, amount]) => {
                if (amount <= 0) return;
                const catIdx = getNodeIndex(category);
                links.push({ source: incomeIdx, target: catIdx, value: amount });
            });

            Object.entries(expenseSubcategories).forEach(([category, subcategories]) => {
                const catIdx = getNodeIndex(category);
                Object.entries(subcategories).forEach(([subcategory, amount]) => {
                    const subNodeName = `${subcategory}`;
                    const subIdx = getNodeIndex(subNodeName);
                    links.push({ source: catIdx, target: subIdx, value: amount });
                });
            });

            const width = container.clientWidth;
            const height = 500;

            const svg = d3.select('#sankey')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[1, 1], [width - 1, height - 5]]);

            const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
                nodes: nodes.map(d => Object.assign({}, d)),
                links: links.map(d => Object.assign({}, d))
            });

            const categoryColors = {
                'Income': '#4CAF50',
                'Salary': '#66BB6A',
                'Freelance': '#81C784',
                'Investment': '#A5D6A7',
                'Other Income': '#C8E6C9',
                'Other Expenses': '#8B5CF6',
                'Rent': '#7E5FCF',
                'Food': '#4739A6',
                'Groceries': '#5758C5',
                'Transportation': '#8665DD',
                'Entertainment': '#A265DA',
                'Utilities': '#CC95FF',
                'Shopping': '#47009c',
                'Healthcare': '#6300b9',
                'Education': '#7f00d6',
                'Travel': '#9c2af0',
                'Insurance': '#b666f9',
                'Subscriptions': '#004AAD',
                'Dining Out': '#5758C5',
                'Fitness': '#8665DD',
                'Gifts': '#A265DA'
            };

            const nodeColors = new Map();
            sankeyNodes.forEach((node, i) => {
                if (categoryColors[node.name]) {
                    nodeColors.set(node.name, categoryColors[node.name]);
                } else {
                    const palette = ['#7E5FCF', '#4739A6', '#5758C5', '#8665DD', '#A265DA', '#CC95FF', '#47009c', '#6300b9', '#7f00d6', '#9c2af0', '#b666f9'];
                    nodeColors.set(node.name, palette[i % palette.length]);
                }
            });

            const defs = svg.append('defs');
            
            sankeyLinks.forEach((link, i) => {
                const gradientId = `gradient-${i}`;
                const gradient = defs.append('linearGradient')
                    .attr('id', gradientId)
                    .attr('gradientUnits', 'userSpaceOnUse')
                    .attr('x1', link.source.x1)
                    .attr('x2', link.target.x0);
                
                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', nodeColors.get(link.source.name) || '#667eea');
                
                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', nodeColors.get(link.target.name) || '#667eea');
            });

            svg.append('g')
                .selectAll('path')
                .data(sankeyLinks)
                .join('path')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', (d, i) => `url(#gradient-${i})`)
                .attr('stroke-width', d => Math.max(1, d.width))
                .attr('fill', 'none')
                .attr('opacity', 0.6);

            svg.append('g')
                .selectAll('rect')
                .data(sankeyNodes)
                .join('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', d => nodeColors.get(d.name) || '#667eea')
                .attr('opacity', 0.9)
                .attr('stroke', '#fff')
                .attr('stroke-width', 1);

            svg.append('g')
                .selectAll('text')
                .data(sankeyNodes)
                .join('text')
                .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr('y', d => (d.y1 + d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
                .text(d => `${d.name} (${d.value.toFixed(0)})`)
                .style('font-size', '12px')
                .style('font-weight', '600');
        }

        function toggleEntriesView() {
            const section = document.getElementById('entriesSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                updateEntriesTable();
            } else {
                section.style.display = 'none';
            }
        }

        function updateEntriesTable() {
            const container = document.getElementById('entriesTableContainer');
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>No entries yet</h3>
                        <p>Click "Add Entry" to get started</p>
                    </div>
                `;
                return;
            }

            const sorted = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));

            const table = `
                <table class="entries-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sorted.map(entry => `
                            <tr>
                                <td>${new Date(entry.date).toLocaleDateString()}</td>
                                <td><span class="badge badge-${entry.type}">${entry.type}</span></td>
                                <td>${entry.category}</td>
                                <td>${entry.subcategory || '-'}</td>
                                <td>${entry.amount.toFixed(2)}</td>
                                <td>${entry.notes || '-'}</td>
                                <td>
                                    <div class="entry-actions">
                                        <button class="btn-small btn-edit" onclick="openEditModal('${entry.id}')">Edit</button>
                                        <button class="btn-small btn-delete" onclick="deleteEntry('${entry.id}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }
    </script>
</body>
</html>
